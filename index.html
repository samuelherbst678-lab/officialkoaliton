<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Koalitionsrechner</title>
<style>
  :root {
    --bg: #0b0f14;
    --card: #121823;
    --ink: #e8eef7;
    --muted: #a6b0bf;
    --ok: #37d07a;
    --bad: #ff6a6a;
    --radius: 14px;
  }
  * { box-sizing: border-box; }
  body {
    margin:0; padding:32px;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    background: radial-gradient(1200px 800px at 80% -20%, #1b2b45 0%, #0b0f14 55%);
    color: var(--ink);
  }
  h1 { margin:0 0 8px; font-size: clamp(20px,2.6vw,32px); }
  p.sub { margin:0 0 24px; color:var(--muted); }

  .wrap { display:grid; gap:16px; grid-template-columns:380px 1fr; }
  @media(max-width:980px){ .wrap{ grid-template-columns:1fr; } }

  .card {
    background: linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    padding:16px;
  }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
  .row>* { flex:1; }

  input,select,button {
    border-radius:10px;
    border:1px solid rgba(255,255,255,.12);
    background:#0f1420;
    color:var(--ink);
    padding:10px 12px;
  }
  button { cursor:pointer; font-weight:600; }

  .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .legend .item {
    display:flex; align-items:center; gap:8px;
    font-size:13px;
    background:#0f1420;
    border:1px solid rgba(255,255,255,.08);
    padding:6px 10px;
    border-radius:999px;
  }
  .sw { width:14px; height:14px; border-radius:4px; display:inline-block; }

  .pill { display:inline-flex; align-items:center; gap:8px;
          font-size:13px; padding:6px 10px; border-radius:999px;
          background:#0f1420; border:1px solid rgba(255,255,255,.08); }
  .ok { color:var(--ok); }
  .bad { color:var(--bad); }

  .checklist { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
  .checklist label {
    display:flex; align-items:center; gap:8px;
    border:1px solid rgba(255,255,255,.08);
    padding:8px 10px; border-radius:999px;
    background:#0f1420; cursor:pointer;
  }

  /* Animations für Koalitions-Segmente */
  path.segment {
    transition: transform 0.8s ease-out, fill 0.4s ease;
    transform-origin: left bottom;
  }
  path.segment.coalition {
    transform: translateY(0px);
  }
  path.segment.non-coalition {
    fill: #555; /* grau */
  }
</style>
</head>
<body>
  <h1>Koalitionsrechner – Proportionale Sitzverteilung</h1>
  <p class="sub">Koalition auswählen und die Sitze live sehen. „Andere“ sitzt nie im Parlament.</p>

  <div class="wrap">
    <section class="card">
      <div class="row">
        <div><label>Gesamtsitze</label><input id="totalSeats" type="number" value="630"></div>
        <div><label>Sperrklausel (%)</label><input id="threshold" type="number" value="5" step="0.1"></div>
      </div>
      <div class="row">
        <button id="calcBtn" type="button">Neu berechnen</button>
      </div>
      <div class="checklist" id="coalitionChecklist"></div>
    </section>

    <section class="card">
      <svg id="seatChart" viewBox="0 0 900 550" preserveAspectRatio="xMidYMin meet"></svg>
      <div class="legend" id="legend"></div>

      <div class="row" style="margin-top:12px">
        <div class="pill"><strong>Mehrheitsschwelle:</strong> <span id="majorityLbl">316</span></div>
        <div class="pill"><strong>Sitze Koalition:</strong> <span id="coalSeats">0</span></div>
        <div class="pill"><strong>Mehrheit?</strong> <span id="coalMajority" class="bad">nein</span></div>
      </div>
    </section>
  </div>

<script>
/* --- Safari-Polyfill für CSS.escape --- */
if (!window.CSS || typeof CSS.escape !== "function") {
  window.CSS = window.CSS || {};
  CSS.escape = function(value) {
    return String(value).replace(/[\0-\x1F\x7F]/g, "\uFFFD")
      .replace(/^[0-9-]/, "\\$&")
      .replace(/[^a-zA-Z0-9_\u00A0-\uFFFF-]/g, "\\$&");
  };
}

const defaultParties = [
  {name:"CDU/CSU", color:"#000000", pct:28},
  {name:"SPD",     color:"#E3000F", pct:17},
  {name:"Grüne",   color:"#1FA12E", pct:12},
  {name:"FDP",     color:"#FFED00", pct:6},
  {name:"AfD",     color:"#009EE0", pct:20},
  {name:"Linke",   color:"#BE3075", pct:6},
  {name:"BSW",     color:"#FF6A00", pct:7},
  {name:"Andere",  color:"#7e8799", pct:4}
];

/* Sainte-Laguë (wie vorher) */
function allocateSeats(parties, totalSeats){
  const factor=1000000, Q=[];
  parties.forEach((p,i)=>{ const v=p.pct*factor;
    for(let k=0;k<totalSeats+5;k++){ Q.push({i,val:v/(k+0.5)}); }
  });
  Q.sort((a,b)=>b.val-a.val);
  const top=Q.slice(0,totalSeats);
  const c=new Array(parties.length).fill(0);
  top.forEach(q=>c[q.i]++);
  return c;
}

/* WICHTIG: „Andere“ wird IMMER ausgeschlossen */
function computeSeats(parties, totalSeats, threshold){
  const ok = parties.filter(p => p.name !== "Andere" && p.pct >= threshold);
  const result = parties.map(p=>({...p,seats:0}));
  if(ok.length === 0) return result;
  const counts = allocateSeats(ok,totalSeats);
  ok.forEach((p,idx)=>{
    const i = parties.findIndex(pp=>pp.name===p.name);
    result[i].seats = counts[idx];
  });
  return result;
}

function drawHalfRing(svg, data, totalSeats, coalitionNames){
  svg.innerHTML="";
  const w=900, h=550, cx=w/2, cy=h*0.95;
  const rOuter=230, rInner=80;
  let total = data.reduce((a,b)=>a+b.seats,0);
  if(total===0) total=totalSeats;
  let start=Math.PI;
  const g=document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("transform",`translate(${cx},${cy})`);
  svg.appendChild(g);

  function arcPath(r1,r2,a0,a1){
    const large=(a1-a0)>Math.PI?1:0;
    const x0o=r1*Math.cos(a0), y0o=r1*Math.sin(a0);
    const x1o=r1*Math.cos(a1), y1o=r1*Math.sin(a1);
    const x1i=r2*Math.cos(a1), y1i=r2*Math.sin(a1);
    const x0i=r2*Math.cos(a0), y0i=r2*Math.sin(a0);
    return `M ${x0o} ${y0o} A ${r1} ${r1} 0 ${large} 1 ${x1o} ${y1o}
            L ${x1i} ${y1i} A ${r2} ${r2} 0 ${large} 0 ${x0i} ${y0i} Z`;
  }

  data.forEach(p=>{
    const share=p.seats/total;
    const sweep=share*Math.PI;
    const end=start+sweep;
    if(sweep>0){
      const path=document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d",arcPath(rOuter,rInner,start,end));
      path.setAttribute("data-name",p.name);
      path.classList.add("segment");
      // Koalition farbig + „hochfahren“, Rest grau
      if(coalitionNames.includes(p.name)){
        path.classList.add("coalition");
        path.setAttribute("fill",p.color);
        path.style.transform="translateY(50px)"; // Start unten
        requestAnimationFrame(()=>{ path.style.transform="translateY(0px)"; });
      } else {
        path.classList.add("non-coalition");
        path.setAttribute("fill","#555");
      }
      g.appendChild(path);
    }
    start=end;
  });

  document.getElementById("majorityLbl").textContent=(Math.floor(totalSeats/2)+1).toString();
}

function renderLegend(data){
  const legend=document.getElementById("legend");
  legend.innerHTML="";
  data.filter(p=>p.seats>0).forEach(p=>{
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`<span class="sw" style="background:${p.color}"></span>${p.name} – ${p.seats}`;
    legend.appendChild(el);
  });
}

function renderChecklist(data){
  const wrap=document.getElementById("coalitionChecklist");
  wrap.innerHTML="";
  data.forEach((p,idx)=>{
    if(p.seats>0){
      const lab=document.createElement("label");
      lab.innerHTML=`<input type="checkbox" data-idx="${idx}"><span class="sw" style="background:${p.color}"></span>${p.name}`;
      wrap.appendChild(lab);
    }
  });
  wrap.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.addEventListener("change", calcAndRender);
  });
}

function calcAndRender(){
  const totalSeats=parseInt(document.getElementById("totalSeats").value)||0;
  const threshold=parseFloat(document.getElementById("threshold").value)||0;

  // Sitze berechnen (Andere ist immer raus)
  const seatsData=computeSeats(defaultParties,totalSeats,threshold);

  // Ausgewählte Koalition abfragen
  const selected=[];
  document.querySelectorAll("#coalitionChecklist input[type=checkbox]").forEach(cb=>{
    if(cb.checked) selected.push(seatsData[cb.dataset.idx].name);
  });

  // Zeichnen + UI
  drawHalfRing(document.getElementById("seatChart"),seatsData,totalSeats,selected);
  renderLegend(seatsData);
  renderChecklist(seatsData);

  // Koalitionssumme & Mehrheit
  const sum=seatsData.filter(p=>selected.includes(p.name)).reduce((a,b)=>a+b.seats,0);
  document.getElementById("coalSeats").textContent=sum;
  const majority=Math.floor(totalSeats/2)+1;
  const ok=sum>=majority;
  document.getElementById("coalMajority").textContent=ok?"ja":"nein";
  document.getElementById("coalMajority").className=ok?"ok":"bad";
}

document.getElementById("calcBtn").addEventListener("click",calcAndRender);
calcAndRender();
</script>
</body>
</html>
