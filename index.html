<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Koalitionsrechner – Proportionale Sitzverteilung</title>
<style>
  :root {
    --bg:#0b0f14; --card:#121823; --ink:#e8eef7; --muted:#a6b0bf;
    --ok:#37d07a; --bad:#ff6a6a; --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:32px; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    background:radial-gradient(1200px 800px at 80% -20%, #1b2b45 0%, #0b0f14 55%);
  }
  h1{margin:0 0 8px; font-size:clamp(20px,2.6vw,32px)}
  p.sub{margin:0 0 24px; color:var(--muted)}
  .wrap{display:grid; gap:16px; grid-template-columns:380px 1fr}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius); padding:16px;
  }
  .row{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap}
  .row>*{flex:1}
  input,select,button{
    border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0f1420; color:var(--ink); padding:10px 12px;
  }
  input[type="color"]{padding:0; height:38px; width:100%}
  button{cursor:pointer; font-weight:600}
  button.secondary{background:#0f1420}
  .party-row{
    display:grid; grid-template-columns:26px 1.3fr .9fr .7fr 1fr 26px;
    gap:8px; align-items:center; margin:8px 0;
  }
  .party-row .handle{opacity:.6; text-align:center; font-size:12px}
  .party-row .del{opacity:.7; cursor:pointer; text-align:center}
  .legend{display:flex; flex-wrap:wrap; gap:8px}
  .legend .item{
    display:flex; align-items:center; gap:8px; font-size:13px;
    background:#0f1420; border:1px solid rgba(255,255,255,.08);
    padding:6px 10px; border-radius:999px;
  }
  .sw{width:14px; height:14px; border-radius:4px; display:inline-block; border:1px solid rgba(255,255,255,.3)}
  .pill{display:inline-flex; align-items:center; gap:8px; font-size:13px; padding:6px 10px; border-radius:999px; background:#0f1420; border:1px solid rgba(255,255,255,.08)}
  .checklist{display:flex; flex-wrap:wrap; gap:10px}
  .checklist label{display:flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:999px; background:#0f1420}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  svg{display:block; width:100%; height:auto}
  .arc{opacity:1; transition:opacity .25s ease, transform .25s ease}
  .arc.enter{opacity:0; transform:translate(-20px,20px)}
  .arc.leave{opacity:0; transform:scale(1.02)}
</style>
</head>
<body>
  <h1>Koalitionsrechner – Proportionale Sitzverteilung</h1>
  <p class="sub">Koalition links im Halbkreis – mit sanfter Animation beim Anklicken.</p>

  <div class="wrap">
    <section class="card" id="inputsCard">
      <div class="row">
        <div><label>Gesamtsitze</label><input id="totalSeats" type="number" value="630"></div>
        <div><label>Sperrklausel (%)</label><input id="threshold" type="number" value="5" step="0.1"></div>
      </div>
      <div class="row">
        <div><label>Wahlverfahren</label>
          <select id="method">
            <option value="sls" selected>Sainte-Laguë/Schepers</option>
            <option value="dhondt">d’Hondt</option>
            <option value="hare">Hare-Niemeyer</option>
          </select>
        </div>
        <div><label>Ausnahmen (z. B. SSW)</label><input id="exceptions" placeholder="SSW"></div>
      </div>
      <div class="row" style="justify-content:space-between">
        <button id="addRowBtn" type="button">+ Partei hinzufügen</button>
        <div style="display:flex; gap:8px">
          <button id="resetBtn" class="secondary" type="button">Zurücksetzen</button>
          <button id="calcBtn" type="button">Neu berechnen</button>
        </div>
      </div>
      <div class="muted" style="margin:6px 0 4px">Parteien & Prozentwerte (Name, % und Farbe frei wählbar)</div>
      <div id="partyList"></div>
    </section>

    <section class="card">
      <svg id="seatChart" viewBox="0 0 900 620" preserveAspectRatio="xMidYMin meet"></svg>
      <div class="legend" id="legend"></div>

      <div class="row" style="margin-top:12px">
        <div class="pill"><strong>Mehrheitsschwelle:</strong> <span id="majorityLbl">316</span></div>
        <div class="pill"><strong>Sitze Koalition:</strong> <span id="coalSeats">0</span></div>
        <div class="pill"><strong>Mehrheit?</strong> <span id="coalMajority" class="bad">nein</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Koalitionen testen</h3>
        <div class="checklist" id="coalitionChecklist"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Vorgegebene Koalitionen</h3>
        <select id="presetCoalition">
          <option value="">– auswählen –</option>
          <option value="Schwarz-Rot">Schwarz-Rot (GroKo)</option>
          <option value="Schwarz-Grün">Schwarz-Grün</option>
          <option value="Schwarz-Gelb">Schwarz-Gelb</option>
          <option value="Jamaika-Koalition">Jamaika</option>
          <option value="Deutschland-Koalition">Deutschland-Koalition</option>
          <option value="Ampel-Koalition">Ampel</option>
          <option value="Kenia-Koalition">Kenia</option>
          <option value="Brombeer-Koalition">Brombeer</option>
          <option value="Rot-Rot-Grün">Rot-Rot-Grün</option>
          <option value="Rot-Grün-Rot">Rot-Grün-Rot</option>
          <option value="Grün-Rot-Rot">Grün-Rot-Rot</option>
          <option value="SPD-BSW">SPD-BSW</option>
        </select>
      </div>
    </section>
  </div>

<script>
const $  = s => document.querySelector(s);
let selectedCoalition = new Set();
const GREY = "#b7bdc7";
function isOther(name){ return (name||"").toLowerCase().includes("andere") || (name||"").toLowerCase().includes("sonstige"); }

const defaultParties = [
  {name:"CDU/CSU", color:"#000000", pct:28},
  {name:"SPD",     color:"#E3000F", pct:17},
  {name:"Grüne",   color:"#1FA12E", pct:12},
  {name:"FDP",     color:"#FFED00", pct:6},
  {name:"AfD",     color:"#009EE0", pct:20},
  {name:"Linke",   color:"#BE3075", pct:6},
  {name:"BSW",     color:"#FF6A00", pct:7},
  {name:"Andere",  color:"#7e8799", pct:4}
];

/* Sitzverteilung */
function filterByThreshold(ps,t,exc){return ps.filter(p=>!isOther(p.name)&&(p.pct>=t||exc.includes(p.name)));}

function sls(ps,seats){const f=1e6,Q=[];ps.forEach((p,i)=>{const v=p.pct*f;for(let k=0;k<seats+5;k++)Q.push({i,val:v/(k+0.5)})});Q.sort((a,b)=>b.val-a.val);const c=new Array(ps.length).fill(0);Q.slice(0,seats).forEach(q=>c[q.i]++);return c;}
function dhondt(ps,seats){const f=1e6,Q=[];ps.forEach((p,i)=>{const v=p.pct*f;for(let k=1;k<=seats;k++)Q.push({i,val:v/k})});Q.sort((a,b)=>b.val-a.val);const c=new Array(ps.length).fill(0);Q.slice(0,seats).forEach(q=>c[q.i]++);return c;}
function hare(ps,seats){const v=ps.map(p=>p.pct),tot=v.reduce((a,b)=>a+b,0);if(tot===0)return new Array(ps.length).fill(0);const q=v.map(x=>x/tot*seats),b=q.map(Math.floor);let as=b.reduce((a,b)=>a+b,0);q.map((x,i)=>({i,r:x-Math.floor(x)})).sort((a,b)=>b.r-a.r).forEach(o=>{if(as<seats){b[o.i]++;as++;}});return b;}
function allocate(ps,s,m){if(m==="dhondt")return dhondt(ps,s);if(m==="hare")return hare(ps,s);return sls(ps,s);}

function computeSeats(ps,seats,t,exc,m){
  const clean=ps.map(p=>isOther(p.name)?{...p,pct:0}:p);
  const ok=filterByThreshold(clean,t,exc);
  const res=clean.map(p=>({...p,seats:0}));
  if(ok.length){const counts=allocate(ok,seats,m);ok.forEach((p,i)=>{const j=res.findIndex(q=>q.name===p.name);if(j>=0)res[j].seats=counts[i];});}
  return res.map(p=>isOther(p.name)?{...p,seats:0}:p);
}

/* Halbkreis */
function arcD(r1,r2,a0,a1){const large=(a1-a0)>Math.PI?1:0;const x0=r1*Math.cos(a0),y0=r1*Math.sin(a0);const x1=r1*Math.cos(a1),y1=r1*Math.sin(a1);const x1i=r2*Math.cos(a1),y1i=r2*Math.sin(a1);const x0i=r2*Math.cos(a0),y0i=r2*Math.sin(a0);return`M${x0} ${y0}A${r1} ${r1} 0 ${large} 1 ${x1} ${y1}L${x1i} ${y1i}A${r2} ${r2} 0 ${large} 0 ${x0i} ${y0i}Z`;}

function drawHalfRing(svg,data,seats,set){
  const w=900,h=620,cx=w/2,cy=h*0.85,rO=260,rI=80;
  let g=svg.querySelector("g.seats");if(!g){svg.innerHTML="";g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("class","seats");g.setAttribute("transform",`translate(${cx},${cy})`);svg.appendChild(g);}
  const total=data.reduce((a,b)=>a+b.seats,0)||seats;
  let start=Math.PI;
  data.forEach(p=>{
    const share=p.seats/total,sweep=share*Math.PI;
    let path=g.querySelector(`path[data-name="${p.name}"]`);
    if(!path){path=document.createElementNS("http://www.w3.org/2000/svg","path");path.dataset.name=p.name;path.setAttribute("class","arc enter");g.appendChild(path);requestAnimationFrame(()=>path.classList.remove("enter"));}
    path.setAttribute("fill",set.has(p.name)?p.color:GREY);
    path.setAttribute("d",arcD(rO,rI,start,start+sweep));
    start+=sweep;
  });
}

/* Legend, Checklist */
function renderLegend(d){$("#legend").innerHTML="";d.filter(p=>p.seats>0&&!isOther(p.name)).forEach(p=>{const el=document.createElement("div");el.className="item";el.innerHTML=`<span class="sw" style="background:${p.color}"></span><strong>${p.name}</strong> – ${p.seats} Sitze`;$("#legend").appendChild(el);});}
function renderChecklist(d){
  const wrap=$("#coalitionChecklist");wrap.innerHTML="";
  d.filter(p=>p.seats>0&&!isOther(p.name)).forEach(p=>{
    const lab=document.createElement("label");
    lab.innerHTML=`<input type="checkbox" data-name="${p.name}" ${selectedCoalition.has(p.name)?"checked":""}><span class="sw" style="background:${p.color}"></span> ${p.name} (${p.seats})`;
    wrap.appendChild(lab);
  });
  wrap.querySelectorAll("input").forEach(cb=>{
    cb.addEventListener("change",()=>{if(cb.checked)selectedCoalition.add(cb.dataset.name);else selectedCoalition.delete(cb.dataset.name);recalc();});
  });
}

/* Koalitionssumme */
function recomputeSum(d,seats){
  const maj=Math.floor(seats/2)+1;
  const sum=d.reduce((a,p)=>a+(selectedCoalition.has(p.name)?p.seats:0),0);
  $("#coalSeats").textContent=sum;
  $("#majorityLbl").textContent=maj;
  const ok=sum>=maj;$("#coalMajority").textContent=ok?"ja":"nein";$("#coalMajority").className=ok?"ok":"bad";
}

/* Render */
function recalc(){
  const totalSeats=parseInt($("#totalSeats").value)||0;
  const threshold=parseFloat($("#threshold").value)||0;
  const method=$("#method").value;
  const exc=$("#exceptions").value.split(",").map(s=>s.trim()).filter(Boolean);
  const parties=[...$("#partyList").querySelectorAll(".party-row")].map(r=>({name:r.querySelector(".pName").value,color:r.querySelector(".pColor").value,pct:parseFloat(r.querySelector(".pPct").value)||0}));
  const seatsData=computeSeats(parties,totalSeats,threshold,exc,method).filter(p=>p.seats>0&&!isOther(p.name));
  drawHalfRing($("#seatChart"),seatsData,totalSeats,selectedCoalition);
  renderLegend(seatsData);renderChecklist(seatsData);recomputeSum(seatsData,totalSeats);
}

/* Defaults */
function setDefaults(){ $("#partyList").innerHTML=""; defaultParties.forEach(p=>addPartyRow(p)); selectedCoalition=new Set(); recalc(); }
function addPartyRow(p){const row=document.createElement("div");row.className="party-row";row.innerHTML=`<div class="handle">⋮⋮</div><input class="pName" value="${p.name}"><input class="pPct" type="number" value="${p.pct}" step="0.1"><input class="pColor" type="color" value="${p.color}"><label><input type="checkbox" class="pExc"> Ausnahme</label><div class="del">✕</div>`;row.querySelector(".del").onclick=()=>{row.remove();recalc();};$("#partyList").appendChild(row);row.querySelectorAll("input").forEach(inp=>inp.addEventListener("change",recalc));}

/* Events */
$("#addRowBtn").addEventListener("click",()=>{addPartyRow({name:"Neue Partei",color:"#8888ff",pct:0});recalc();});
$("#resetBtn").addEventListener("click",setDefaults);
$("#calcBtn").addEventListener("click",recalc);
$("#totalSeats").addEventListener("change",recalc);
$("#threshold").addEventListener("change",recalc);
$("#method").addEventListener("change",recalc);
$("#exceptions").addEventListener("change",recalc);
$("#presetCoalition").addEventListener("change",()=>{
  const choice=$("#presetCoalition").value;
  const map={
    "Schwarz-Rot":["CDU/CSU","SPD"],
    "Schwarz-Grün":["CD
