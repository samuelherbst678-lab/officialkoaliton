<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Koalitionsrechner – Finale Version</title>
<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: system-ui, sans-serif;
    background: #0b0f14;
    color: #e8eef7;
  }
  h1 { margin-bottom: 10px; }
  .wrap { display: grid; gap: 16px; grid-template-columns: 350px 1fr; }
  .card {
    background: #121823;
    border-radius: 12px;
    padding: 16px;
  }
  .party-row {
    display: grid;
    grid-template-columns: 1fr 70px 60px 30px;
    gap: 6px;
    margin-bottom: 6px;
  }
  input,select,button {
    background: #0f1420; border:1px solid #444; color:#e8eef7;
    border-radius:6px; padding:6px;
  }
  button { cursor:pointer; }
  .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .legend .item {
    display:flex; align-items:center; gap:6px; font-size:13px;
    background:#0f1420; padding:4px 8px; border-radius:999px;
  }
  .sw { width:14px; height:14px; border-radius:3px; display:inline-block; }
  .checklist { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .checklist label {
    display:flex; align-items:center; gap:6px;
    background:#0f1420; padding:6px 10px; border-radius:999px; font-size:13px;
  }
  .ok { color:#37d07a; }
  .bad { color:#ff6a6a; }
  svg path {
    transition: all 0.8s ease;
    transform-origin: center;
  }
</style>
</head>
<body>
  <h1>Koalitionsrechner – Finale Version</h1>
  <div class="wrap">
    <section class="card">
      <div>
        <label>Gesamtsitze</label>
        <input id="totalSeats" type="number" value="630">
      </div>
      <div>
        <label>Sperrklausel (%)</label>
        <input id="threshold" type="number" value="5" step="0.1">
      </div>
      <button id="calcBtn">Neu berechnen</button>
      <div id="partyList"></div>
      <button id="addRowBtn">+ Partei hinzufügen</button>
    </section>

    <section class="card">
      <svg id="seatChart" viewBox="0 0 900 500"></svg>
      <div class="legend" id="legend"></div>

      <div style="margin-top:10px">
        <span><b>Mehrheitsschwelle:</b> <span id="majorityLbl">316</span></span> |
        <span><b>Sitze Koalition:</b> <span id="coalSeats">0</span></span> |
        <span><b>Mehrheit?</b> <span id="coalMajority" class="bad">nein</span></span>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Koalitionen testen</h3>
        <div class="checklist" id="coalitionChecklist"></div>
      </div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const defaultParties = [
  {name:"CDU/CSU", color:"#000000", pct:28},
  {name:"SPD",     color:"#E3000F", pct:17},
  {name:"Grüne",   color:"#1FA12E", pct:12},
  {name:"FDP",     color:"#FFED00", pct:6},
  {name:"AfD",     color:"#009EE0", pct:20},
  {name:"Linke",   color:"#BE3075", pct:6},
  {name:"BSW",     color:"#FF6A00", pct:7},
  {name:"Andere",  color:"#7e8799", pct:4},
];

// --- Zuteilung ---
function allocateSeats(parties,seats){
  const factor=1000000, Q=[];
  parties.forEach((p,i)=>{const v=p.pct*factor; for(let k=0;k<seats+5;k++)Q.push({i,val:v/(k+0.5)})});
  Q.sort((a,b)=>b.val-a.val);
  const top=Q.slice(0,seats), c=new Array(parties.length).fill(0);
  top.forEach(q=>c[q.i]++);
  return c;
}

// --- Sitze berechnen ---
function computeSeats(parties,totalSeats,threshold){
  const ok = parties.filter(p => p.pct>=threshold && p.name!=="Andere");
  const result = parties.map(p=>({...p,seats:0}));
  if(ok.length===0) return result;
  const counts = allocateSeats(ok,totalSeats);
  ok.forEach((p,idx)=>{
    const i = parties.findIndex(pp=>pp.name===p.name);
    result[i].seats = counts[idx];
  });
  result.forEach(p=>{ if(p.name==="Andere") p.seats=0; }); // <--- Andere nie rein
  return result;
}

// --- Zeichnen ---
function drawHalfRing(svg,data,totalSeats,coalitionIdx){
  svg.innerHTML="";
  const w=900,h=500,cx=w/2,cy=h*0.9;
  const rOuter=220, rInner=80;
  let total=data.reduce((a,b)=>a+b.seats,0)||totalSeats;
  let start=Math.PI;

  const g=document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("transform",`translate(${cx},${cy})`);
  svg.appendChild(g);

  data.forEach((p,idx)=>{
    const share=(p.seats||0)/total, sweep=share*Math.PI, end=start+sweep;
    if(sweep>0){
      const path=document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d",arcPath(0,0,rOuter,rInner,start,end));
      const inCoalition = coalitionIdx.includes(idx);
      path.setAttribute("fill", inCoalition ? p.color : "#555");
      path.style.transform="scale(0.8)";
      setTimeout(()=>{path.style.transform="scale(1)";},30);
      g.appendChild(path);
    }
    start=end;
  });

  $("#majorityLbl").textContent=(Math.floor(totalSeats/2)+1);
}

function arcPath(cx,cy,r1,r2,a0,a1){
  const large=(a1-a0)>Math.PI?1:0;
  const x0o=cx+r1*Math.cos(a0), y0o=cy+r1*Math.sin(a0);
  const x1o=cx+r1*Math.cos(a1), y1o=cy+r1*Math.sin(a1);
  const x1i=cx+r2*Math.cos(a1), y1i=cy+r2*Math.sin(a1);
  const x0i=cx+r2*Math.cos(a0), y0i=cy+r2*Math.sin(a0);
  return `M${x0o},${y0o}A${r1},${r1} 0 ${large} 1 ${x1o},${y1o}L${x1i},${y1i}A${r2},${r2} 0 ${large} 0 ${x0i},${y0i}Z`;
}

// --- Legend & Checklist ---
function renderLegend(data){
  $("#legend").innerHTML="";
  data.filter(p=>p.seats>0).forEach(p=>{
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`<span class="sw" style="background:${p.color}"></span>${p.name} – ${p.seats}`;
    $("#legend").appendChild(el);
  });
}
function renderChecklist(data){
  const wrap=$("#coalitionChecklist");
  wrap.innerHTML="";
  data.filter(p=>p.seats>0).forEach((p,idx)=>{
    const lab=document.createElement("label");
    lab.innerHTML=`<input type="checkbox" data-idx="${idx}"><span class="sw" style="background:${p.color}"></span>${p.name} (${p.seats})`;
    wrap.appendChild(lab);
  });
  wrap.querySelectorAll("input").forEach(cb=>cb.addEventListener("change",recomputeCoalitionSum));
}

// --- Koalition ---
function recomputeCoalitionSum(){
  const totalSeats=parseInt($("#totalSeats").value)||0;
  const majority=Math.floor(totalSeats/2)+1;
  const selected=[];
  $("#coalitionChecklist input:checked").forEach(cb=>selected.push(parseInt(cb.dataset.idx)));
  const data=window.__lastSeats||[];
  const sum=selected.reduce((a,i)=>a+(data[i]?.seats||0),0);
  $("#coalSeats").textContent=sum;
  const ok=sum>=majority;
  $("#coalMajority").textContent=ok?"ja":"nein";
  $("#coalMajority").className=ok?"ok":"bad";
  drawHalfRing($("#seatChart"),data,totalSeats,selected);
}

// --- Init ---
function init(){
  $("#partyList").innerHTML="";
  defaultParties.forEach(p=>addPartyRow(p));
  calcAndRender();
}
function addPartyRow(p){
  const row=document.createElement("div");
  row.className="party-row";
  row.innerHTML=`<input class="pName" value="${p.name}">
    <input class="pPct" type="number" value="${p.pct}">
    <input class="pColor" type="color" value="${p.color}">
    <div class="del">✕</div>`;
  row.querySelector(".del").onclick=()=>{row.remove();calcAndRender();};
  $("#partyList").appendChild(row);
  row.querySelectorAll("input").forEach(inp=>inp.addEventListener("change",calcAndRender));
}
function readInputs(){
  const totalSeats=parseInt($("#totalSeats").value)||0;
  const threshold=parseFloat($("#threshold").value)||0;
  const partyRows=$$("#partyList .party-row");
  const parties=partyRows.map(r=>({
    name:r.querySelector(".pName").value,
    pct:parseFloat(r.querySelector(".pPct").value)||0,
    color:r.querySelector(".pColor").value
  }));
  return {totalSeats,threshold,parties};
}
function calcAndRender(){
  const {totalSeats,threshold,parties}=readInputs();
  const seatsData=computeSeats(parties,totalSeats,threshold);
  const shown=seatsData.filter(p=>p.seats>0);
  window.__lastSeats=shown;
  drawHalfRing($("#seatChart"),shown,totalSeats,[]);
  renderLegend(shown);
  renderChecklist(shown);
}
$("#addRowBtn").onclick=()=>{addPartyRow({name:"Neue Partei",color:"#8888ff",pct:0});};
$("#calcBtn").onclick=calcAndRender;
init();
</script>
</body>
</html>
